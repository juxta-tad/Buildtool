use flake

# Register watchman trigger for compdb regeneration
if command -v watchman >/dev/null 2>&1; then
  watchman watch "$PWD" >/dev/null 2>&1
  if ! watchman trigger-list "$PWD" 2>/dev/null | grep -q '"compdb"'; then
    watchman -j <<< '["trigger", "'"$PWD"'", {
      "name": "compdb",
      "expression": ["anyof",
        ["match", "BUCK", "basename"],
        ["match", "*.bzl", "basename"],
        ["match", ".buckconfig", "basename"]
      ],
      "command": ["bash", "-c", "cd '"$PWD"' && db=$(buck2 bxl //bxl:compdb.bxl:generate -- --targets //... 2>/dev/null) && mkdir -p .cache/compdb && ln -sfn \"../../$db\" .cache/compdb/compile_commands.json"]
    }]' >/dev/null 2>&1
  fi
fi
