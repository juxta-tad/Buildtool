use flake

# Compile database generation
mkdir -p .cache/compdb

# Create gen script if missing
if [ ! -x .cache/compdb/gen-compdb.sh ]; then
  cat > .cache/compdb/gen-compdb.sh << 'SCRIPT'
#!/usr/bin/env bash
set -euo pipefail
cd "${WATCHMAN_ROOT:-$(dirname "$0")/../..}"
db=$(buck2 bxl //bxl:compdb.bxl:generate -- --targets //... 2>/dev/null) || exit 0
[ -n "$db" ] && ln -sfn "../../$db" .cache/compdb/compile_commands.json
SCRIPT
  chmod +x .cache/compdb/gen-compdb.sh
fi

# Generate if missing or symlink target doesn't exist
if [ ! -e .cache/compdb/compile_commands.json ] || ! readlink .cache/compdb/compile_commands.json | xargs -I{} test -e "{}"; then
  .cache/compdb/gen-compdb.sh
fi

# Auto-regenerate on BUCK/bzl changes via watchman
if command -v watchman >/dev/null && ! watchman trigger-list "$PWD" 2>/dev/null | grep -q compdb; then
  watchman watch "$PWD" >/dev/null 2>&1
  echo '["trigger", "'"$PWD"'", {
    "name": "compdb",
    "expression": ["anyof",
      ["match", "BUCK", "basename"],
      ["match", "*.bzl", "basename"],
      ["match", ".buckconfig", "basename"]
    ],
    "command": [".cache/compdb/gen-compdb.sh"]
  }]' | watchman -j >/dev/null 2>&1
fi
