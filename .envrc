use flake

# Auto-regenerate on BUCK/bzl changes via watchman
ROOT="$(pwd)"
if command -v watchman >/dev/null; then
  watchman watch "$ROOT" >/dev/null 2>&1
  # Always update trigger to ensure command matches current config
  watchman trigger-del "$ROOT" compdb >/dev/null 2>&1
  echo '["trigger", "'"$ROOT"'", {
    "name": "compdb",
    "expression": ["anyof",
      ["match", "BUCK", "basename"],
      ["match", "*.bzl", "basename"],
      ["match", ".buckconfig", "basename"]
    ],
    "command": ["tools/gen-compdb.sh"]
  }]' | watchman -j >/dev/null 2>&1
fi
